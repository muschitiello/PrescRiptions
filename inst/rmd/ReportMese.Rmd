---
title: "PrescRipitions "
subtitle: "England Report ***`r params$monthTitle`*** \n"
pagetitle: "Report `r params$monthTitle`"
# author: "cristina.muschitiello@infocamere.it"
date: "`r format(Sys.time(), '%e %B %Y')`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_depth: 4
    toc_float: 
      collapsed: true
      smooth_scroll: true
    number_sections: false
  fig_caption: true
  includes:
    in_header: header.tex
  keep_tex: true
  pandoc_args: --tab-stop=2
  bookdown::pdf_book:
    df_print: paged
    toc: true
    toc_depth: 4
    number_sections: false
params:
  monthTitle: monthTitle
  prefix: prefix
  rawData:  rawData
  outputFolder: outFolder
  inputFolder: inputFolder
  summaryFolder: summaryFolder
header-includes:
- \usepackage{makeidx}
- \makeindex
- \usepackage{float} #use the 'float' package
- \floatplacement{figure}{H} #make every figure with caption = h
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{amsthm}
- \usepackage{mathtools}
---
\listoftables

\listoffigures

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r sumstep, include=FALSE, echo=FALSE}
nameCheck = paste0(params$prefix,"_CheckSteps.csv")
nameSummary = paste0(params$prefix,"_stepsNumbers.csv")
checkStep = data.table(read.csv2(paste0(params$summaryFolder,"/",nameCheck)))
summaryStep = data.table(read.csv2(paste0(params$summaryFolder,"/",nameSummary)))
checkStepFormat = copy(checkStep)
setnames(checkStepFormat,colnames(checkStepFormat),c("step", "descrizione", "Records", "Soci","Imprese",  "Rimossi"))
rawData = data.table(read.csv2(params$rawData, check.names = FALSE))
paramsR=defaultPesiParameters()
nstep=0
```

<span style="color:#0077b3">------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>

<span style="background-color:#e6f7ff">Questo e' un report generato automaticamente.</span> 


<span style="background-color:#e6f7ff">La sezione <span style="color:#0077b3">**Dati Aggregati**</span> continene alcune aggregazioni finali relative al mese analizzato.</span>

<span style="background-color:#e6f7ff">La sezione <span style="color:#0077b3">**Report `r params$monthTitle`**</span> contiene una tabella di summary dei diversi step e, successivamemente, il dettaglio dei singoli step per il mese anlizzato.</span>

<span style="background-color:#e6f7ff">La sezione <span style="color:#0077b3">**Metodologia**</span> contiene la descrizione della metodologia utilizzata in ciascuno step.</span>

<span style="color:#0077b3">------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>

### <span style="color:#0077b3">**Dati Aggregati**</span>

```{r aggregati, include=TRUE}

tab = checkStep[step==16,3:5]

valoriFinaliImp = data.table(read.csv2(paste0(params$inputFolder,"/outputFinal_csv/",params$prefix,"dataImprese_final.csv"),check.names = FALSE))
capSoc = round(valoriFinaliImp[,sum(IMP_CAPITALE_SOCIALE_MAX)]/1000000000,4)

valoriFinaliPart = data.table(read.csv2(paste0(params$inputFolder,"/outputFinal_csv/",params$prefix,"dataCleaned2Share_final.csv"),check.names = FALSE))

valNom = round(valoriFinaliPart[,sum(get(paramsR$quotaValAssoVar))]/1000000000,4)

tabAll = cbind(tab, round(capSoc,4), round(valNom,4))

setnames(tabAll, colnames(tabAll),c("N Records","N Soci", "N Imprese", "Tot cap soc (MLD)","Tot Val Nom (MLD)"))

numCols = c("N Records","N Soci", "N Imprese", "Tot cap soc (MLD)","Tot Val Nom (MLD)")

setDT(tabAll)[, (numCols):= lapply(.SD, function(x) format(x,big.mark = ".",decimal.mark = ",",scientific = FALSE)),
              .SDcols = numCols]
  
knitr::kable(tabAll,
             caption = paste0("Valori Aggregati relativi al mese ",params$monthTitle)) %>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
                ,bootstrap_options = c("hold_position", "repeat_header","striped", "hover", "condensed", "responsive")
  ) 

```


<span style="color:#0077b3">------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>


### <span style="color:#0077b3">**Report `r params$monthTitle`**</span>

#### **Summary**

```{r summary, include=TRUE}
  setDT(checkStepFormat)[, colnames(checkStepFormat):= lapply(.SD, function(x) format(x,big.mark = ".",decimal.mark = ",",scientific = FALSE)),
              .SDcols = colnames(checkStepFormat)]

  setnames(summaryStep,colnames(summaryStep),c("step","descrizione","Records","Imprese","Soci","Azione","Unique"))
  summaryStep=summaryStep[,mget(c("step","descrizione","Records","Soci","Imprese","Azione","Unique"))]

   suppressWarnings(setDT(summaryStep)[, colnames(summaryStep)[3:5]:= lapply(.SD, function(x) as.integer(as.character(x))),
              .SDcols = colnames(summaryStep)[3:5]])

  setDT(summaryStep)[, colnames(summaryStep):= lapply(.SD, function(x) format(x,big.mark = ".",decimal.mark = ",",scientific = FALSE)),
              .SDcols = colnames(summaryStep)]

knitr::kable(checkStepFormat,
             caption = "Tabella di Summary")%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
                ,bootstrap_options = c("hold_position", "repeat_header","striped", "hover", "condensed", "responsive"))

```

`r nstep = nstep`
#### **Step `r nstep`**: `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))`  [*$\small{(\rightarrow)}$*](#anchor0) {#backanchor0} 

Il file raw ha le seguenti caratteristiche: 

```{r step0, include=TRUE}
checkStepFormat=checkStepFormat[step==" 0"]
checkStepFormat[,Variabili:=rawData[,nCdata]]

knitr::kable(checkStepFormat)%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
                ,bootstrap_options = c("hold_position", "repeat_header","striped", "hover", "condensed", "responsive"))

```


`r nstep = nstep + 1`
#### **Step `r nstep`**: `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))`  [*$\small{(\rightarrow)}$*](#anchor1) {#backanchor1}


```{r step1, include=TRUE}
stepSum=summaryStep[trimws(step)==nstep,mget(c("step","descrizione","Records","Soci","Imprese","Azione"))]

knitr::kable(stepSum)%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
                ,bootstrap_options = c("hold_position", "repeat_header","striped", "hover", "condensed", "responsive"))

```

`r nstep = nstep + 1`
#### **Step `r nstep`**: `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))`  [*$\small{(\rightarrow)}$*](#anchor2) {#backanchor2}


```{r step2, include=TRUE}
stepSum=summaryStep[trimws(step)==nstep,mget(c("step","descrizione","Records","Soci","Imprese","Azione"))]

knitr::kable(stepSum)%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
                ,bootstrap_options = c("hold_position", "repeat_header","striped", "hover", "condensed", "responsive"))

```


`r nstep = nstep + 1`
#### **Step `r nstep`**: `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))`  [*$\small{(\rightarrow)}$*](#anchor3) {#backanchor3}

```{r step3, include=TRUE}
stepSum=summaryStep[trimws(step)==nstep,mget(c("step","descrizione","Records","Soci","Imprese","Azione"))]

setDT(stepSum)[, colnames(stepSum)[3:5]:= lapply(.SD, function(x) format(x,big.mark = ".",decimal.mark = ",",scientific = FALSE)),
              .SDcols = colnames(stepSum)[3:5]]

knitr::kable(stepSum)%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
                ,bootstrap_options = c("hold_position", "repeat_header","striped", "hover", "condensed", "responsive"))

```



`r nstep = nstep + 1`
#### **Step `r nstep`**: `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))`  [*$\small{(\rightarrow)}$*](#anchor4) {#backanchor4}

```{r step4, include=TRUE}
stepSum=summaryStep[trimws(step)==nstep,mget(c("step","descrizione","Records","Soci","Imprese","Azione"))]

PF = ifelse(stepSum[,Azione]=="counted","mantenute","eliminate")

```

Per il  mese in corso le osservazioni relative alle Persone Fisiche sono state `r PF`.

```{r step4b, include=TRUE}
knitr::kable(stepSum)%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
                ,bootstrap_options = c("hold_position", "repeat_header","striped", "hover", "condensed", "responsive"))
```

`r nstep = nstep + 1`
#### **Step `r nstep`**: `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))`  [*$\small{(\rightarrow)}$*](#anchor5) {#backanchor5}

```{r step5, include=TRUE}
stepSum=summaryStep[trimws(step)==nstep,Soci]
```

`r stepSum` Denominazioni sono state corrette. I valori corretti sono stati salvati in un file esterno, per eventuali controlli.  Il file è contenuto al seguente link: 

([*$\small{\rightarrow folder}$*](./summaryTables)) [*`r paste0(params$summaryFolder,"/",params$prefix,"_step5_denomChanged.csv")`*](./summaryTables/`r paste0(params$prefix,"_step5_denomChanged.csv")`). 

`r nstep = nstep + 1`
#### **Step `r nstep`**: `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))`  [*$\small{(\rightarrow)}$*](#anchor6) {#backancho6}

```{r step6, include=TRUE}
stepSum=summaryStep[trimws(step)==nstep,mget(c("step","descrizione","Records","Soci","Imprese","Azione"))]

knitr::kable(stepSum)%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
                ,bootstrap_options = c("hold_position", "repeat_header","striped", "hover", "condensed", "responsive"))

```

I valori corretti sono stati salvati in un file esterno, per eventuali controlli.  Il file è contenuto al seguente link: 

([*$\small{\rightarrow folder}$*](./summaryTables)) [*`r paste0(params$summaryFolder,"/",params$prefix,"_step6_Unmapped_TIT_STATO.csv")`*](./summaryTables/`r paste0(params$prefix,"_step6_Unmapped_TIT_STATO.csv")`). 


`r nstep = nstep + 1`
#### **Step `r nstep`**: `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))`  [*$\small{(\rightarrow)}$*](#anchor7) {#backanchor7}

```{r step7, include=TRUE}
stepSum=summaryStep[trimws(step)==nstep,mget(c("step","descrizione","Records","Soci","Imprese","Azione"))]

knitr::kable(stepSum)%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
                ,bootstrap_options = c("hold_position", "repeat_header","striped", "hover", "condensed", "responsive"))

```

`r nstep = nstep + 1`
#### **Step `r nstep`**: `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))`  [*$\small{(\rightarrow)}$*](#anchor8) {#backanchor8}

```{r step8, include=TRUE}
stepSum=summaryStep[trimws(step)==nstep,mget(c("step","descrizione","Records","Soci","Imprese","Azione"))]

knitr::kable(stepSum)%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
                ,bootstrap_options = c("hold_position", "repeat_header","striped", "hover", "condensed", "responsive"))

```


`r nstep = nstep + 1`
#### **Step `r nstep`**: `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))`  [*$\small{(\rightarrow)}$*](#anchor9) {#backanchor9}

```{r step9, include=TRUE}
stepSum=summaryStep[trimws(step)==nstep,mget(c("step","descrizione","Records","Soci","Imprese","Azione"))]

knitr::kable(stepSum)%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
                ,bootstrap_options = c("hold_position", "repeat_header","striped", "hover", "condensed", "responsive"))

```

CDi seguito una tabella con la distribuzione dei diritti titolare: 


```{r step9b, include=TRUE}
# dirTitTable = fread(paste0(params$summaryFolder,"/",params$prefix,"_step9_TabSatatusDir.csv"))
# 
#   setDT(dirTitTable)[, colnames(dirTitTable):= lapply(.SD, function(x) format(x,big.mark = ".",decimal.mark = ",",scientific = FALSE)),
#               .SDcols = colnames(dirTitTable)]
# 
# 
# knitr::kable(dirTitTable)%>%
#   kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
#                 ,bootstrap_options = c("hold_position", "repeat_header","striped", "hover", "condensed", "responsive"))

```

`r nstep = nstep + 1`
#### **Step `r nstep`**: `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))`  [*$\small{(\rightarrow)}$*](#anchor10) {#backanchor10}

```{r step10, include=TRUE}
stepSum=summaryStep[trimws(step)==nstep,mget(c("step","descrizione","Records","Soci","Imprese","Azione"))]

knitr::kable(stepSum)%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
                ,bootstrap_options = c("hold_position", "repeat_header","striped", "hover", "condensed", "responsive"))

```

`r nstep = nstep + 1`
#### **Step `r nstep`**: `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))`  [*$\small{(\rightarrow)}$*](#anchor11) {#backanchor11}

```{r step11, include=TRUE}
stepSum=summaryStep[trimws(step)==nstep,mget(c("step","descrizione","Records","Soci","Imprese","Azione"))]

knitr::kable(stepSum)%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
                ,bootstrap_options = c("hold_position", "repeat_header","striped", "hover", "condensed", "responsive"))

noCom = trimws(stepSum[which(grepl("Anagrafica Imprese - Comuni Istat missing",descrizione)),Imprese])
noProv = trimws(stepSum[which(grepl("Anagrafica Imprese - Regioni/Province Istat missing",descrizione)),Imprese])
nopStkvTable = fread(paste0(params$summaryFolder,"/",params$prefix,"_step",nstep,"_ImpNoStkvMese.csv"),fill = T)

noStkv = nrow(nopStkvTable)

```

In base alla tabella risulta che per ***`r noCom `*** imprese è stato necessario ricorrere al codice provincia, poichè il codice comune non era disponibile. 

Fra queste, per  ***`r noProv `*** imprese non è stato possibile riconoscere nemmeno il codice provincia. 

***`r noStkv `*** imprese risultavano mancanti in Stockview Mese. I dettagli di tali imprese sono salvati nel seguente file: 

([*$\small{\rightarrow folder}$*](./summaryTables)) [*`r paste0(params$summaryFolder,"/",params$prefix,"_ImpNoStkvMese.csv")`*](./summaryTables/`r paste0(params$prefix,"_ImpNoStkvMese.csv.csv")`). 


Tutte le ***`r noCom `*** imprese per le quali sono state usate proxi per la localizzazione del mese sono contenute nel seguente file: 


([*$\small{\rightarrow folder}$*](./summaryTables)) [*`r paste0(params$summaryFolder,"/",params$prefix,"_step11_AnagraficaComuneProxi.csv")`*](./summaryTables/`r paste0(params$prefix,"_step11_AnagraficaComuneProxi.csv")`). 



`r nstep = nstep + 1`
#### **Step `r nstep`**: `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))`  [*$\small{(\rightarrow)}$*](#anchor12) {#backanchor12}

```{r step12, include=TRUE}
stepSum=summaryStep[trimws(step)==nstep,mget(c("step","descrizione","Records","Soci","Imprese","Azione"))]

knitr::kable(stepSum)%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
                ,bootstrap_options = c("hold_position", "repeat_header","striped", "hover", "condensed", "responsive"))

```

`r nstep = nstep + 1`
#### **Step `r nstep`**: `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))`  [*$\small{(\rightarrow)}$*](#anchor13) {#backanchor13}

```{r step13, include=TRUE}
stepSum=summaryStep[trimws(step)==nstep,mget(c("step","descrizione","Records","Soci","Imprese","Azione"))]

knitr::kable(stepSum)%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
                ,bootstrap_options = c("hold_position", "repeat_header","striped", "hover", "condensed", "responsive"))

```


`r nstep = nstep + 1`
#### **Step `r nstep`**: `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))`  [*$\small{(\rightarrow)}$*](#anchor14) {#backanchor14}

```{r step14, include=TRUE}
stepSum=summaryStep[trimws(step)==nstep,mget(c("step","descrizione","Records","Soci","Imprese","Azione"))]

knitr::kable(stepSum)%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
                ,bootstrap_options = c("hold_position", "repeat_header","striped", "hover", "condensed", "responsive"))

```


`r nstep = nstep + 1`
#### **Step `r nstep`**: `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))`  [*$\small{(\rightarrow)}$*](#anchor15) {#backanchor15}

```{r step15, include=TRUE}
stepSum=summaryStep[trimws(step)==nstep,mget(c("step","descrizione","Records","Soci","Imprese","Azione"))]

knitr::kable(stepSum)%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
                ,bootstrap_options = c("hold_position", "repeat_header","striped", "hover", "condensed", "responsive"))

```

Le imprese che risultano essere con Socio Unico, pur avendo più soci indicati nei dati in analisi, sono riportate nel file: 


([*$\small{\rightarrow folder}$*](./summaryTables)) [*`r paste0(params$summaryFolder,"/",params$prefix,"_step15_inconsistent_socioUnico.csv")`*](./summaryTables/`r paste0(params$prefix,"_step15_inconsistent_socioUnico.csv")`). 


`r nstep = nstep + 1`
#### **Step `r nstep`**: `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))`  [*$\small{(\rightarrow)}$*](#anchor16) {#backanchor16}



```{r step16, include=TRUE}
stepSum=summaryStep[trimws(step)==nstep,mget(c("step","descrizione","Records","Soci","Imprese","Azione"))]

knitr::kable(stepSum)%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
                ,bootstrap_options = c("hold_position", "repeat_header","striped", "hover", "condensed", "responsive"))

```




`r nstep = nstep + 1`
#### **GENERAZIONE OUTPUT**: `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))`  [*$\small{(\rightarrow)}$*](#anchor17) {#backanchor17}

Tutti gli output sono contenuti al seguente link, suddivisi nelle diverse cartelle, per tipologia di output: 


([*$\small{\rightarrow csv}$*](./outputFinal_csv))

([*$\small{\rightarrow RData}$*](./outputFinal_RData))

([*$\small{\rightarrow txt}$*](./outputFinal_txt))


<span style="color:#0077b3">------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>

### <span style="color:#0077b3"> **Metodologia ([M])**</span>


`r nstep = 0`
#### <span style="color:#0077b3">**Metodologia step `r nstep`**:</span>  `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))` [*$\small(\leftarrow back)$ *](#backanchor0) {#anchor0}

I Dati Raw provengono dal nuovo DWH anagraficaSoci generato da Infocenter. 
La procedura importa l'intero dataset. 

Le label relative alle variabili sono parametrizzate. Una funzione verifica che tutte le variabili necessarie al Cleaning siano presenti.

`r nstep = 1`
#### <span style="color:#0077b3">**[M] step `r nstep`**:</span>  `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))` [*$\small(\leftarrow)$ *](#backanchor1) {#anchor1}

Date le seguenti definizioni: 

 - <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$impCapSocVar`]</span> = Capitale Impresa
 
 - <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$impValCapSocVar`]</span> = Valuta Capitale Impresa
 
 - <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$quotaValutaVar`]</span> = Valuta Quota
 
 - <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$quotaValAssoVar`]</span> = Valore assoluto posseduto da ciascun titolare di quota
 
 - <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$quotaValorePraticaVar`]</span> = Valore dell'intera quota (che può avere piu' di un titolare)
 
 - <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$quotaPercentVar`]</span> = Percentuale di quota posseduta da ciascun titolare = $\frac{[Valore Assoluto Quota]}{[Capitale]}$ 
 
 - <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$prgpratVar`]</span> = Identificativo di ciascuna Quota (corrispondente ad un solo <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$quotaValorePraticaVar`]</span>)
 
 - <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$prgTitVar`]</span> = Identificativo di ciascun titolare di Qutoa (corrispondente ad un solo <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$quotaValAssoVar`]</span> e <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$quotaPercentVar`]</span>) 

Vengono eseguite le seguenti operazioni

 - Se <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$impValCapSocVar`] = NA </span> & <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$quotaValutaVar`] = noNA</span>, allora <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$impValCapSocVar`] = [`r paramsR$quotaValutaVar`]</span>
 
 - Se <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$quotaValutaVar`] = NA</span>  & <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$impValCapSocVar`]= noNA </span>, allora <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$quotaValutaVar`]</span> = <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$impValCapSocVar`]</span>

 - Se <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$impCapSocVar`] = NA</span> & `[Valore Pratica Quota] = noNA`, allora <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$impCapSocVar`]= sum(unique[`r paramsR$quotaValorePraticaVar`], by[`r paramsR$impCodFiscVar`], [`r paramsR$prgpratVar`])`</span> 
 
 - Se <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$impCapSocVar`] = NA</span> & <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$quotaValAssoVar`] = noNA</span>, allora <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$impCapSocVar`] = sum([`r paramsR$quotaValAssoVar`], by[`r paramsR$impCodFiscVar`], [`r paramsR$prgpratVar`])</span>

Talei operazioni necessitano la quadratura delle quote e la presenza di tutti i soci, italiani e stranieri, pertanto devono essere eseguite sull'intero dataset e non posono essere eseguite sul dataset filtrato con le sole partecipazioni straniere. 

**NB**:  <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$quotaValorePraticaVar`]</span> non viene ricalcolata, pertanto questo insieme di operazioni può generare casi in cui  <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$quotaValAssoVar`] = noNA </span> e <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$quotaValorePraticaVar`] = 0 </span.

`r nstep = nstep+1`
#### <span style="color:#0077b3">**[M] step `r nstep`**:</span> `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))` [*$\small(\leftarrow)$*](#backanchor2) {#anchor2}

Eliminazione partecipazioni italiane sulla base dello stato del titolare <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$titStatoVar`]</span> corrispondente a: 

 - Lo stato dichiarato come stato della sede dell'impresa nel RI (laddove disponibile per il titolare), oppure
 - La cittadinanza del titolare <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$titStatoCittadVar`]</span> (laddove disponibile nelle tabelle del DB), oppure
 - Il domicilio del titolare <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$titStatoDomicilioVar`]</span>.

Laddove nessuna delle informazioni risulti disponibile, lo stato del titolare resta indefinito. 
Per coerenza rispetto a procedure precedenti, in questo step vengono eliminate tutte le righe con <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$titStatoVar`] = ITALIA </span>. 

Le righe con Stato indefinito sono conservate in questo step. 

`r nstep = nstep+1`
#### <span style="color:#0077b3">**[M] step `r nstep`**:</span> `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))` [*$\small(\leftarrow)$*](#backanchor3) {#anchor3}

Il DWH anagraricaSoci accoglie le sole societa' di capitali, tuttavia possono essere presenti alcune società di persone. 
Ciò accade quando una società di persone sia stata in passato societa' di capitali e abbia, siccessivamente, mutato natura giuridica. 

Tali Società sono rimosse in questo step. 

Per l'inclusione delle societa' di persone si attende che Infocenter sciluppi una banca dati relativa a tutte le società con questa natura giuridica.

`r nstep = nstep+1`
#### <span style="color:#0077b3">**[M] step `r nstep`**:</span> `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))` [*$\small(\leftarrow)$ *](#backanchor4) {#anchor4}

E' possibile includere o escludere i titolari che siano persone fisiche. 

In questo step i titolari persone fisiche sono conteggiati o eliminati, a seconda dell'opzione selezionata. 

Poichè in passato questa tipologia di titolari era esclusa, l'opzione di default è l'eliminazione dei titolari persone fisiche.

`r nstep = nstep+1`
#### <span style="color:#0077b3"> **[M] step `r nstep`**:</span> `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))` [*$\small(\leftarrow)$ *](#backanchor5) {#anchor5}

1. La denominazione del titolare è cotenuta in piu' colonne del DWH: 
 
 - Cognome <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$titCognomeVar`]</span>
 - Nome <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$titNomeVar`]</span>
 - Denominazione <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$titDenomVar`]</span>
    
Sebbene la regola dovrebbe essere la seguente: 
    
 - per i soci persone fisiche la denominazione è data da <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$titCognomeVar`]</span> + <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$titNomeVar`]</span>,
 - per i soci persone giuridiche la denominazione è data da <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$titDenomVar`]</span>.


Ciò non sempre avviene. Pertanto è stato aggiunto un algoritmo (validato da INFOCENTER) che calcola la denominazione in un unico campo come segue: 

 - se <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$titDenomVar`]</span> = `[NOT NULL]`, allora <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$titDenomCalcVar`]</span> = <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$titDenomVar`]</span>.
 - altrimenti  <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$titDenomCalcVar`]</span> = <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$titCognomeVar`]</span> + <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$titNomeVar`]</span>

2. La <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$titDenomCalcVar`]</span> subisce un controllo di coerenza. Si verifica che non vi siano denominazioni differenti solo per punteggiatura (es. *“SAVOR SPOL S.R.O.” e “SAVOR SPOL. S.R.O.”*, oppure *“KME A.G.” e “KME AG”*). I casi di questo tipo vengono resi omogenei. Le denominazioni modificate vengono salvate in un file esterno, per finalità di controllo.
 

`r nstep = nstep+1`
#### <span style="color:#0077b3">**[M] step `r nstep`**:</span> `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))` [*$\small(\leftarrow)$ *](#backanchor6) {#anchor6}

 - Per tutti gli <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$titStatoVar`]</span> , al codice nazione si associa il nome paese contentuo nel DB ORACLE
 - Le righe della variabile <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$titStatoVar`]</span> con valore non valido (*NA*, 0, *XXX* e *simili*) vengono riportate in un file esterno.
 - ORACLE **`T_NAZIONI`** contiene anche i codici ISO3 per tutti i paesi riconosciuti da tale classificazione internazionale. Tale colonna viene aggiunta al file delle partecipate. 
 - Si effettuano alcuni conteggi: 
    + Stato socio ISO3
    + Stato socio non ISO3
    + Stato socio non Rilevabile (*0*, *8*, *XXX*, *XX*, *000*)
    + Stato socio = *ESCURSIONISTI ESTERI*
    + Stato socio = *APOLIDE*
 - Infine tutti i valori corrispondenti a *Non Rilevabile* vengono convertiti ad un unico valore di missing : ***X***.
 
`r nstep = nstep+1`
#### <span style="color:#0077b3">**[M] step `r nstep`**:</span> `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))` [*$\small(\leftarrow)$ *](#backanchor7) {#anchor7}

Le seguenti denominazioni titolare <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$titDenomCalcVar`]</span> specifiche vengono ***rimosse***: 

 - *TRIBUNALE*
 - *PROCURA*
 - *OSPEDALE*
 - *SOCI SCONOSCIUTI*
 - *ISTITUTO TECNICO AGRARIO*
 - *A.N.A.P.I.A. SARDEGNA*

`r nstep = nstep+1`
#### <span style="color:#0077b3">**[M] step `r nstep`**:</span> `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))` [*$\small(\leftarrow)$ *](#backanchor8) {#anchor8}

Le imprese Cessate vengono rimosse.

`r nstep = nstep+1`
#### <span style="color:#0077b3">**[M] step `r nstep`**:</span> `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))` [*$\small(\leftarrow)$ *](#backanchor9) {#anchor9}

vengono ***rimosse*** tutte le righe con diritto titolare diverso da:

 - *PROPRIETA'*, 
 - *NUDA PROPRIETA'*, 
 - *TRUSTEE*, 
 - *INTESTAZIONE FIDUCIARIA*

Nonchè le Quote che presentano vincoli. Tale informazione è presa da DB e si riferisce alla presenza di altre tipologie di vincoli, oltre alla titolarità, quali, ad esempio, un accordo verbale fra le parti. Tale informazione è codificata in un flag che indica la presenza o meno di vincoli. Le quote con Vincoi vengono escluse dai dati.

Inoltre viene salvata una tabella contenente una tabella di sitnesi relativa alla distribuzione dei diritti titolare. 

`r nstep = nstep+1`
#### <span style="color:#0077b3">**[M] step `r nstep`**:</span> `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))` [*$\small(\leftarrow)$ *](#backanchor10) {#anchor10}

Il dataset Raw contiene i `[codici attivita']` delle imprese. Questi vengono convertiti in codici a 2 cifre e, a partire da questi vengono estratti dal DB oracle le info relative a descrizione e settore ateco, sia in italiano che in inglese.

In particolare, la funzione genera le seguenti variabili: 

 - `[IMP_ATECO_SETTORE]`
 - `[IMP_ATECO_SETTORE_LABEL]`
 - `[IMP_ATECO_SETTORE_DESCRIZIONE_ENG]`
 - `[IMP_ATECO_DIVISIONE]`

`r nstep = nstep+1`
#### <span style="color:#0077b3">**[M] step `r nstep`**:</span> `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))` [*$\small(\leftarrow)$ *](#backanchor11) {#anchor11}

A partire dai `[CCIAA]` e `[REA]` delle imprese, si straggono i codici istat di regioni, comuni e province, utili per fini successivi di localizzazione dell'impresa: 

 - `[IMP_REGIONE_NOME]`
 - `[IMP_ISTAT_REGIONE]`
 - `[IMP_ISTAT_COMUNE]`
 - `[IMP_PROVINCIA_NOME]`
 - `[IMP_ISTAT_PROVINCIA]`

In particolare, si eseguono is eguenti step:

 1. Tramite CCIAA e REA vengono cercate in Stockview Mese le Chiavi Comune, usate per l'estrazione dei codici Comune e provincia da Bdge. A tal fine si accede a Stockview del mese antecedente quello di analisi (non essndo presente in DB il mese corrente). Può accadere che alcune imprese risultimo mancanti. Queste vengono salvate in un file estermo per successivi controlli e poi si procede a recuperare le inofrmazioni da altre tabelle, come di seguito descritto.
 
 2. Le imprese non in Stockview Mese vengono cercate nella tabella relativa al trimestre precedente.
 
 3. Laddove restino imprese ancora mancanti, per queste si usa come proxi del codice comune, il codice della provincia. 

Le informazioni relative 

NB. In alcuni casi alcune 


`r nstep = nstep+1`
#### <span style="color:#0077b3">**[M] step `r nstep`**:</span> `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))` [*$\small(\leftarrow)$ *](#backanchor12) {#anchor12}

Le seguenti denominazioni impresa `[IMP_DENOMINAZIONE]`specifiche vengono ***rimosse***: 

 - *AVATAR*
 - *TEJAS* 
 - *COSECARE* 
 - *MAGURO* 
 - *AVKA*
 - *TETRAKOS*
 - *STELLAR*

Inoltre si rimuove la punteggiatura dalle denominazioni impresa, per eliminare casi come *\"\"LAMINAL S.R.L.\"\"* o altre formattazioni che possono generare problemi nelle tabelle.

`r nstep = nstep+1`
#### <span style="color:#0077b3">**[M] step `r nstep`**:</span> `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))` [*$\small(\leftarrow)$ *](#backanchor13) {#anchor13}

 - Rimozione codici fiscali per quali sia le Valute capitale <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$impValCapSocVar`]</span> che le valute quota <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$params$quotaValutaVar`]</span> sono mancanti 
 - Rimozione codici fiscali per i quali sia il capitale <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$impCapSocVar`]</span> che tutti i valori di quota (<span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$quotaValAssoVar`]</span> e <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$quotaValorePraticaVar`]</span>) sono mancanti
 - Rimozione delle righe per le quali il capitale <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$impCapSocVar`]</span> = 0
 - Traduzione Valuta capitale sociale. In questa fase i Capitali espressi in valuta diversa dall'euro sono convertiti sulla base di una tabella di conversione standard delle valute verso l'Euro

`r nstep = nstep+1`
#### <span style="color:#0077b3">**[M] step `r nstep`**:</span> `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))` [*$\small(\leftarrow)$ *](#backanchor14) {#anchor14}

 - Rimozione delle righe in cui <span style="background-color:#ededed;font-size:88%;font-family:Lucida Console">[`r paramsR$quotaValAssoVar`] > [`r paramsR$impCapSocVar`]</span>
 - Eliminazione dei valori di quota per i Consorzi e Le aziende a Statuto speciale: Nei consorzi non esiste il valore nominale delle quote, anche perché spesso non esiste il capitale. Infatti il capitale varia in funzione del numero di soci/consorziati che si iscrivono o escono (e ciò avviene con alta frequenza). Il DWH raw mostra solo il valore del capitale deliberato (se esistente) e non fornisce alcuna informazione con riferimento alle quote. 
Allo Stesso modo ci sono Cooperative ed aziende a Statuto Speciale. Anche per queste non è possibile considerare il valore delle quote. 
Poichè in alcuni passaggi precedenti potrebbero essere state erroneamente generati dei valori per le quote di queste imprese, in questo step vengono eliminati. Le nature giuridiche in questione sono le seguenti: 
 
```{r consorzi, include=TRUE, echo=FALSE}
# consorzi = c("CO","CC","CF","CM","CR","CS","CZ","CO","CC","SO","CL","SC","RC","OC","OO","CN","PS","OS","CZ","AC","FO","PC",
#                 "GE","FI","LL","AL","CS","SS","CR","AI","EP","SZ","CM","CF","SM","CI","EN","MA","AF","SV","AE","SD","AN","DI","EI","ST")

consorzi = c("CC","CF","CM","CO","CR","CZ","LL","RC","OO","EP","RC")

natGiur = importNatGiur(jarFolder = jarFolder,params = paramsR)

natGiurTable = natGiur[get(paramsR$impNatGiuVar)%in%consorzi,mget(c(paramsR$impNatGiuVar,"DESCRIZIONE"))]

knitr::kable(natGiurTable)%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
                ,bootstrap_options = c("hold_position", "repeat_header","striped", "hover", "condensed", "responsive"))

```


`r nstep = nstep+1`
#### <span style="color:#0077b3">**[M] step `r nstep`**:</span> `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))` [*$\small(\leftarrow)$ *](#backanchor16) {#anchor16}

In questo step si verifica se esistono Societa' con Socio unico (SRL o SPA) per le quali esistono piu' titolari esteri. 
Qualora presenti, le righe corrispondenti vengono salvate in un file esterno per successive verifiche. 

`r nstep = nstep+1`
#### <span style="color:#0077b3">**[M] step `r nstep`**:</span> `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))` [*$\small(\leftarrow)$ *](#backanchor17) {#anchor17}

Vengono eliminate le società quotate. Ciò poichè la compagine sociale di tali società varia troppo raèidamente.

`r nstep = nstep+1`
#### <span style="color:#0077b3">**[M] GENERAZIONE OUTPUT**:</span> `r firstup(tolower(as.character(checkStep[step==nstep,descrizione])))` [*$\small(\leftarrow)$ *](#backanchor18) {#anchor18}

A valle dell'intero processo vengono prodotti output separati in 3 diversi formati: **.RData**, **.csv** e **.txt** contenuti nelle cartelle: 
 
 - */outputFinal_txt* [*$\small{\leftarrow}$*](./outputFinal_txt)
 - */outputFinal_RData* [*$\small{\leftarrow}$*](./outputFinal_RData)
 - */outputFinal_csv* [*$\small{\leftarrow}$*](./outputFinal_csv)

```{r output, include=TRUE, echo=FALSE}

txtOut = paste0(params$inputFolder,"/outputFinal_txt")

outs = gsub(".txt","",list.files(txtOut))

```

###### <span style="color:#0077b3">***1. `r outs[2]`***</span>

 - <span style="color:#0077b3">VARIABILI/COLONNE</span>: Contiene tutte e variabili (vedi [*appendice 2*](#anchorappendice2){#backappendice2}), comprese molte di quelle raw che sono state elaborate e modificate^[durante il cleaning, alcune variabili raw sono modificate, altre invece sono usate per generarne di nuove. In questo secondo caso esistono due variabili con lo stesso significato, quella originaria + quella modificata/corretta. Il file della presente sezione non elimina nessuna colonna, pertanto alcune colonne sono ridondanti e potrebbero essere confondenti.]. Tale file è conservato per scopi di analisi, ma non è conveniente condividerlo.
 
 - <span style="color:#0077b3">RIGHE</span>: Contiene tante righe quante sono le partecipazioni (combinazioni socio/impresa).

###### <span style="color:#0077b3">***2. `r outs[1]`***</span>

 - <span style="color:#0077b3">VARIABILI/COLONNE</span>: Contiene una selezione di variabili (vedi [*appendice 2*](#anchorappendice2){#backappendice2}). In tal caso tutte le variabili ridondanti sono escluse. Tale file può, quindi, essere condiviso.
 
 - <span style="color:#0077b3">RIGHE</span>: Contiene tante <span style="color:#0077b3">RIGHE</span> quante sono le partecipazioni (combinazioni socio/impresa).
 
###### <span style="color:#0077b3">***3. `r outs[8]`***</span>

 - <span style="color:#0077b3">VARIABILI/COLONNE</span>: Contiene le variabili inerenti le informazioni del socio persona fisica e/o giuridica (vedi [*appendice 2*](#anchorappendice2){#backappendice2}). Sono contenuti aggrgati, come il numero di partecipazioni detenute da ciascun socio (anche in società diverse), mentre sono escluse le informazioni relative a singole quote (es: valore pratica o natura giuridica)
 
 - <span style="color:#0077b3">RIGHE</span>: Contiene tante righe quante sono i soci. 
 

###### <span style="color:#0077b3">***4. `r outs[3]`***</span>

 - <span style="color:#0077b3">VARIABILI/COLONNE</span>: Contiene le variabili inerenti le informazioni dell'impresa (vedi [*appendice 2*](#anchorappendice2){#backappendice2}).

 - <span style="color:#0077b3">RIGHE</span>: Contiene tante righe quante sono le imprese partecipate.

###### <span style="color:#0077b3">***6. `r outs[4]`***</span>
 
 - <span style="color:#0077b3">VARIABILI/COLONNE</span>: Contiene solamente le seguenti variabili aggregate per SETTORE ATECO:
   + Somma Capitale Bilancio `[ATECO_SUM_CAPITALE]`.
   + Somma Valori nominali delle quote`[ATECO_QUOTA_NOMINALI_SUM]`.
   + Numero di partecipazioni`[PARTECIPAZIONI_NUM_BY_ATECO]`.

 - <span style="color:#0077b3">RIGHE</span>: Contiene tante righe quanti sono i settori ATECO a due cifre.

###### <span style="color:#0077b3">***7. `r outs[5]`***</span>

 - <span style="color:#0077b3">VARIABILI/COLONNE</span>: Contiene solamente le seguenti variabili aggregate per NATURA GIURIDICA:
   + Somma Capitale Bilancio`[NG_SUM_CAPITALE]`.
   + Somma Valori nominali delle quote`[NG_QUOTA_NOMINALI_SUM]`.
   + Numero di partecipazioni`[PARTECIPAZIONI_NUM_BY_NATURA_GIURIDICA]`.

 - <span style="color:#0077b3">RIGHE</span>: Contiene tante righe quanti sono i tipi di NATURA GIURIDICA.

###### <span style="color:#0077b3">***8. `r outs[6]`***</span>

 - <span style="color:#0077b3">VARIABILI/COLONNE</span>: Contiene solamente le seguenti variabili aggregate per REGIONE:
   + Somma Capitale Bilancio`[REGIONE_SUM_CAPITALE]`.
   + Somma Valori nominali delle quote`[REGIONE_QUOTA_NOMINALI_SUM]`.
   + Numero di partecipazioni`[PARTECIPAZIONI_NUM_BY_REGIONE]`.

 - <span style="color:#0077b3">RIGHE</span>: Contiene tante righe quante sono le REGIONI.

###### <span style="color:#0077b3">***9. `r outs[7]`***</span>

 - <span style="color:#0077b3">VARIABILI/COLONNE</span>: Contiene solamente le seguenti variabili aggregate per STATO:
   + Somma Valori nominali delle quote`[STATO_QUOTA_NOMINALI_SUM]`.
   + Numero di partecipazioni`[PARTECIPAZIONI_NUM_BY_STATO]`.
 
 - <span style="color:#0077b3">RIGHE</span>: Contiene tante righe quanti sono gli STATI.

**NB**: La Somma Capitale Bilancio in questo caso è esclusa poichè, essendo le partecipazioni e le imprese comuni a più stati, non ci sarebbe coincidenza nei totali, ciò essendo confondente per il lettore.

<span style="color:#0077b3">------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>


### <span style="color:#0077b3">**Appendici**</span> 

##### **1. Variabili di Output** [*$\small(\leftarrow)$ *](#backappendice1) {#anchorappendice1}

Di seguito si riporta l'elenco di tutte le variabili di output e l'indicazione di quelle incluse ed escluse da ciascuno dei file di output:

```{r app2, fig.pos = "H"}
#dataCleanedAll
load(paste0(params$outputFolder,"/outputFinal_RData/",params$prefix,"dataCleanedAll_final.RData"))
colAll = colnames(dataCleanedAll)

#dataCleaned2Share
load(paste0(params$outputFolder,"/outputFinal_RData/",params$prefix,"dataCleaned2Share_final.RData"))
colShare=colnames(dataCleaned2Share)

#dataImprese
load(paste0(params$outputFolder,"/outputFinal_RData/",params$prefix,"dataImprese_final.RData"))
colImp=colnames(dataImprese)

#dataSoci
if(file.exists(paste0(params$outputFolder,"/outputFinal_RData/",params$prefix,"dataSoci_final.RData"))){
  load(paste0(params$outputFolder,"/outputFinal_RData/",params$prefix,"dataSoci_final.RData"))
}else{
    load(paste0(params$outputFolder,"/outputFinal_RData/",params$prefix,
                "dataSoci_final_denominazioneSocioINVALIDA.RData"))
}
colSoci=colnames(dataSoci)
VarTable = data.table(colAll)
for(i in 1:length(colAll)){
VarTable[i,varshare:=ifelse(any(colShare==VarTable[i,colAll]),"-","")]
VarTable[i,varImp:=ifelse(any(colImp==VarTable[i,colAll]),"-","")]
# VarTable[i,varPart:=ifelse(any(colPart==VarTable[i,colAll]),"-","")]
VarTable[i,varSoci:=ifelse(any(colSoci==VarTable[i,colAll]),"-","")]
}
#
# setnames(VarTable,colnames(VarTable),c("Variabili Output","Variabili data2Share", "Variabili dataImprese", "Variabili dataPartecipazioni", "Variabili dataSoci" ))


setnames(VarTable,colnames(VarTable),c("Variabili All","Variabili data2Share", "Variabili dataImprese", "Variabili dataSoci" ))


kable(VarTable, booktabs = T, longtable = TRUE,
             caption = "Variabili Finali con Etichette di Output")%>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
                ,bootstrap_options = c("hold_position", "repeat_header","striped", "bordered", "hover", "condensed", "responsive"))%>%
   kableExtra::scroll_box(height = "400px")

```

