---
title: <span style="color:#E95420">**England Report** - ***`r params$monthTitle`***</span>
subtitle: "**PrescRiptions**"
author: "Authors: *Cristina Muschitiello* - *NiccolÃ² Stamboglis*"
pagetitle: "PrescRiptions Report `r params$monthTitle`"
date: "**e-Rum2020** - 20th June 2020"
output:
  html_document:
    theme: united
    highlight: default
    df_print: paged
    toc: true
    toc_depth: 4
    toc_float: 
      collapsed: true
      smooth_scroll: true
    number_sections: false
  fig_caption: true
  includes:
    in_header: header.tex
  keep_tex: true
  pandoc_args: --tab-stop=2
  # bookdown::pdf_book:
  #   df_print: paged
  #   toc: true
  #   toc_depth: 4
  #   number_sections: false
params:
  year: year,
  month: month,
  monthName: NameMonth,
  monthTitle: monthTitle
  prefix: prefix
  geoArea: geo  
  outputFolder: outFolder
  inputFolder: inputFolder
  monthData: monthData
  settings: settings
header-includes:
- \usepackage{makeidx}
- \makeindex
- \usepackage{float} #use the 'float' package
- \floatplacement{figure}{H} #make every figure with caption = h
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{amsthm}
- \usepackage{mathtools}
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
ggplot2::theme_set(ggthemes::theme_economist()) # Sets graphs themes to "The Economist" style
```

```{r dataImport, include=FALSE, echo=FALSE}

for (i in 1:length(params$monthData)){
  # print(names(dataAll)[i])
  assign(gsub("[[:digit:]]|_","",names(monthData))[i],params$monthData[[i]])
}

regionPrescriptions = PrescRiptions::generateSummaries(plpd,bnf,on = "REGION",params$settings)
bnfPrescriptions = PrescRiptions::generateSummaries(plpd,bnf,on = "BNF",params$settings)


```
# **Basic information**

### *Description*

This report provides summary information on prescriptions provided in `r params$geoArea ` during `r params$monthTitle `. This report is generated automatically using the package **PrescRiptions**.

### *Summary*

In `r params$geoArea` during `r params$monthTitle ` the following numbers were registered:


```{r table1,  include=TRUE}

numCols = colnames(regionPrescriptions)

data.table::setDT(regionPrescriptions)[, (numCols):= lapply(.SD, function(x) format(x,big.mark = ".",decimal.mark = ",",scientific = FALSE)),
              .SDcols = numCols]

knitr::kable(regionPrescriptions,format = "html",
             caption = "Region Numbers") %>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
                ,bootstrap_options = c("hold_position", "repeat_header","striped", "hover", "condensed", "responsive")
  ) 
```

# **Analysis by BNF Code**

This section provides information on prescriptions organised by BNF code.

### *Prescribed items*

Information on individual BNF codes can be summarised as follows.

**Prescribed items by BNF code** are distributed by BNF code as follows

```{r, echo=FALSE, fig.width=8, fig.height=6}


p <- ggplot(bnfPrescriptions, aes(x=reorder(BNF.Chapter, -ITEMS), y=ITEMS)) +
  geom_bar(stat="identity", width=.5, fill="tomato3") +
  labs(title="Items by BNF Chapter",
       subtitle="England", 
       caption="source: NHS",
       x="BNF.Chapter") + 
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 20))+
   scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6))+
  theme(axis.text.x = element_text(size=9,angle=90, vjust=0.4, hjust=1))+
  theme(axis.text.y = element_text(size=9,vjust=0.4, hjust=1))+
  theme(axis.title.x = element_text(margin=margin(10,10,0,0)))+
  theme(axis.title.y = element_text(margin=margin(10,10,10,0)))
p

```

### *Actual Costs*

**Actual costs by BNF code** are distributed by BNF code as follows

```{r, echo=FALSE, fig.width=8, fig.height=6}
p <- ggplot(bnfPrescriptions, aes(x=reorder(BNF.Chapter, -ACT.COST), y=ACT.COST)) + 
  geom_bar(stat="identity", width=.5, fill="tomato3") + 
  labs(title="Actual costs by BNF Chapter", 
       subtitle="England", 
       caption="source: NHS",
       x="BNF.Chapter") + 
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 20))+
   scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6))+
  theme(axis.text.x = element_text(size=9,angle=90, vjust=0.4, hjust=1))+
  theme(axis.text.y = element_text(size=9,vjust=0.4, hjust=1))+
  theme(axis.title.x = element_text(margin=margin(10,10,0,0)))+
  theme(axis.title.y = element_text(margin=margin(10,10,10,0)))
p
```


### *Prescribed quantity*

**Total prescribed quantity by BNF code** are distributed by BNF code as follows

```{r, echo=FALSE, fig.width=8, fig.height=6}
p <- ggplot(bnfPrescriptions, aes(x=reorder(BNF.Chapter, -QUANTITY), y=QUANTITY)) + 
  geom_bar(stat="identity", width=.5, fill="tomato3") + 
  labs(title="Total quantity by BNF Chapter", 
       subtitle="England", 
       caption="source: NHS",
       x="BNF.Chapter") + 
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 20))+
   scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6))+
  theme(axis.text.x = element_text(size=9,angle=90, vjust=0.4, hjust=1))+
  theme(axis.text.y = element_text(size=9,vjust=0.4, hjust=1))+
  theme(axis.title.x = element_text(margin=margin(10,10,0,0)))+
  theme(axis.title.y = element_text(margin=margin(10,10,10,0)))
p
```


### *Summary table*

The information on prescription by BNF chapter are summarised in the following table

```{r, echo=FALSE, fig.width=8, fig.height=6}
numCols = colnames(bnfPrescriptions)

data.table::setDT(bnfPrescriptions)[, (numCols):= lapply(.SD, function(x) format(x,big.mark = ".",decimal.mark = ",",scientific = FALSE)),
              .SDcols = numCols]

# reactable(bnfPrescriptions[,1:5], paginationType = "jump", defaultPageSize = 6)

```

<!-- seconda opzione tabella -->

```{r table2,  include=TRUE}

knitr::kable(bnfPrescriptions[,1:5],format = "html") %>%
  kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header","striped")
                ,bootstrap_options = c("hold_position", "repeat_header","striped", "hover", "condensed", "responsive")
  ) %>%
   kableExtra::scroll_box(height = "350px")
```


## Data source

Information on prescriptions have been obtained from NHS. Additional information on prescriptions can be found at this website https://digital.nhs.uk/data-and-information/publications/statistical/practice-level-prescribing-data.

All information are made available via the PrescRiption package.
